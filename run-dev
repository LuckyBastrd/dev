#!/usr/bin/env bash
set -e

# --------------------------------------------------
# Resolve source directory (repo root)
# --------------------------------------------------
CHEZMOI_SOURCE="$(cd "$(dirname "$0")" && pwd)"

# --------------------------------------------------
# Utilities
# --------------------------------------------------
has_cmd() {
  command -v "$1" >/dev/null 2>&1
}

# --------------------------------------------------
# Install Homebrew (macOS only)
# --------------------------------------------------
install_brew() {
  [[ "$(uname -s)" == "Darwin" ]] || {
    echo "Error: Homebrew install attempted on non-macOS system"
    exit 1
  }

  echo "üç∫ Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  if [[ -x /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -x /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
}

# --------------------------------------------------
# Install chezmoi
# --------------------------------------------------
install_chezmoi() {
  local os_name="$1"

  echo "üì¶ Installing chezmoi..."

  case "$os_name" in
    arch)
      sudo pacman -S --noconfirm chezmoi
      ;;
    mac)
      brew install chezmoi
      ;;
    *)
      echo "Error: Unsupported OS for chezmoi installation"
      exit 1
      ;;
  esac
}

# --------------------------------------------------
# Prompt to apply
# --------------------------------------------------
prompt_apply() {
  read -r -p "Apply dotfiles now? (y/N): " answer
  case "$answer" in
    [Yy]*)
      echo "‚úÖ Applying dotfiles..."
      chezmoi apply
      ;;
    *)
      echo "‚ÑπÔ∏è  Skipped. Run 'chezmoi apply' later."
      ;;
  esac
}

# --------------------------------------------------
# Main
# --------------------------------------------------
main() {
  local os_name apply_mode="prompt"

  # Parse args
  case "${1:-}" in
    --apply)    apply_mode="yes" ;;
    --no-apply) apply_mode="no" ;;
  esac

  # OS detection
  case "$(uname -s)" in
    Linux*)
      [[ -f /etc/arch-release ]] || {
        echo "Error: Unsupported Linux distribution"
        exit 1
      }
      os_name="arch"
      ;;
    Darwin*)
      os_name="mac"
      ;;
    *)
      echo "Error: Unsupported operating system"
      exit 1
      ;;
  esac

  # macOS: ensure Homebrew
  if [[ "$os_name" == "mac" ]] && ! has_cmd brew; then
    install_brew
  fi

  # Ensure chezmoi
  if ! has_cmd chezmoi; then
    install_chezmoi "$os_name"
  fi

  # Init only if needed
  if chezmoi source-path >/dev/null 2>&1; then
    echo "‚úÖ Chezmoi already initialized"
  else
    echo "üìÅ Initializing chezmoi from:"
    echo "   $CHEZMOI_SOURCE"
    chezmoi init --source "$CHEZMOI_SOURCE"
  fi

  # Apply behavior
  case "$apply_mode" in
    yes)
      echo "‚úÖ Applying dotfiles..."
      chezmoi apply
      ;;
    no)
      echo "‚ÑπÔ∏è  Skipping apply (--no-apply)"
      ;;
    prompt)
      prompt_apply
      ;;
  esac
}

main "$@"
