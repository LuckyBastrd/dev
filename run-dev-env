#!/usr/bin/env bash
set -e

# --------------------------------------------------
# Resolve source directory (repo root)
# --------------------------------------------------
CHEZMOI_SOURCE="$(cd "$(dirname "$0")" && pwd)"

# --------------------------------------------------
# Utilities
# --------------------------------------------------
has_cmd() {
  command -v "$1" >/dev/null 2>&1
}

# --------------------------------------------------
# Update git submodules
# --------------------------------------------------
update_submodules() {
  echo "üîÑ Updating git submodules..."
  
  if [[ ! -d "$CHEZMOI_SOURCE/.git" ]]; then
    echo "‚ÑπÔ∏è  Not a git repository, skipping submodules"
    return 0
  fi
  
  if [[ ! -f "$CHEZMOI_SOURCE/.gitmodules" ]]; then
    echo "‚ÑπÔ∏è  No submodules found"
    return 0
  fi
  
  cd "$CHEZMOI_SOURCE"
  
  echo "üì• Updating submodules to tracked commits..."
  if ! git submodule update --init --recursive; then
    echo "‚ùå Failed to update submodules"
    return 1
  fi
  
  echo "‚úÖ Submodules updated"
}

# --------------------------------------------------
# Prompt to update submodules
# --------------------------------------------------
prompt_update_submodules() {
  # Check if submodules exist first
  if [[ ! -f "$CHEZMOI_SOURCE/.gitmodules" ]]; then
    return 0
  fi
  
  read -r -p "Update git submodules? (y/N): " answer
  case "$answer" in
    [Yy]*)
      update_submodules || echo "‚ö†Ô∏è  Submodule update had issues, continuing..."
      ;;
    *)
      echo "‚ÑπÔ∏è  Skipped submodule update"
      ;;
  esac
}

# --------------------------------------------------
# Install Homebrew (macOS only)
# --------------------------------------------------
install_brew() {
  [[ "$(uname -s)" == "Darwin" ]] || {
    echo "Error: Homebrew install attempted on non-macOS system"
    exit 1
  }
  echo "üç∫ Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  if [[ -x /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -x /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi
}

# --------------------------------------------------
# Install chezmoi
# --------------------------------------------------
install_chezmoi() {
  local os_name="$1"
  echo "üì¶ Installing chezmoi..."
  case "$os_name" in
    arch)
      sudo pacman -S --noconfirm chezmoi
      ;;
    mac)
      brew install chezmoi
      ;;
    *)
      echo "Error: Unsupported OS for chezmoi installation"
      exit 1
      ;;
  esac
}

# --------------------------------------------------
# Prompt to apply
# --------------------------------------------------
prompt_apply() {
  read -r -p "Apply dotfiles now? (y/N): " answer
  case "$answer" in
    [Yy]*)
      echo "‚úÖ Applying dotfiles..."
      chezmoi apply
      ;;
    *)
      echo "‚ÑπÔ∏è  Skipped. Run 'chezmoi apply' later."
      ;;
  esac
}

# --------------------------------------------------
# Main
# --------------------------------------------------
main() {
  local os_name apply_mode="prompt" update_subs="prompt"
  
  # Parse args
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --apply)
        apply_mode="yes"
        shift
        ;;
      --no-apply)
        apply_mode="no"
        shift
        ;;
      --update-submodules|--update-subs)
        update_subs="yes"
        shift
        ;;
      --no-update-subs)
        update_subs="no"
        shift
        ;;
      --help|-h)
        echo "Usage: $0 [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --apply              Apply dotfiles without prompting"
        echo "  --no-apply           Skip applying dotfiles"
        echo "  --update-submodules  Update git submodules without prompting"
        echo "  --no-update-subs     Skip updating submodules"
        echo "  --help, -h           Show this help message"
        echo ""
        echo "Examples:"
        echo "  $0                          # Interactive mode (asks for everything)"
        echo "  $0 --apply                  # Auto-apply, prompt for submodules"
        echo "  $0 --update-subs --apply    # Auto everything"
        echo "  $0 --no-update-subs         # Skip submodules, prompt for apply"
        exit 0
        ;;
      *)
        echo "Unknown option: $1"
        echo "Use --help for usage information"
        exit 1
        ;;
    esac
  done
  
  # Update submodules based on mode
  case "$update_subs" in
    yes)
      update_submodules || echo "‚ö†Ô∏è  Submodule update had issues, continuing..."
      ;;
    no)
      echo "‚ÑπÔ∏è  Skipping submodule update (--no-update-subs)"
      ;;
    prompt)
      prompt_update_submodules
      ;;
  esac
  
  # OS detection
  case "$(uname -s)" in
    Linux*)
      [[ -f /etc/arch-release ]] || {
        echo "Error: Unsupported Linux distribution"
        exit 1
      }
      os_name="arch"
      ;;
    Darwin*)
      os_name="mac"
      ;;
    *)
      echo "Error: Unsupported operating system"
      exit 1
      ;;
  esac
  
  # macOS: ensure Homebrew
  if [[ "$os_name" == "mac" ]] && ! has_cmd brew; then
    install_brew
  fi
  
  # Ensure chezmoi
  if ! has_cmd chezmoi; then
    install_chezmoi "$os_name"
  fi
  
  # Init only if needed
  if chezmoi source-path >/dev/null 2>&1; then
    echo "‚úÖ Chezmoi already initialized"
  else
    echo "üìÅ Initializing chezmoi from:"
    echo "   $CHEZMOI_SOURCE"
    chezmoi init --source "$CHEZMOI_SOURCE"
  fi
  
  # Apply behavior
  case "$apply_mode" in
    yes)
      echo "‚úÖ Applying dotfiles..."
      chezmoi apply
      ;;
    no)
      echo "‚ÑπÔ∏è  Skipping apply (--no-apply)"
      ;;
    prompt)
      prompt_apply
      ;;
  esac
}

main "$@"
